name: Check Image Links

on:
  schedule:
    # Run daily at 03:00 and 10:00 UTC (11:00 and 18:00 Beijing time)
    - cron: '0 3,10 * * *'
  workflow_dispatch:
  pull_request:
    types: [labeled]

jobs:
  check-links:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    if: github.event_name != 'pull_request' || github.event.label.name == 'check-image-links'
    concurrency:
      group: image-link-check-${{ github.repository }}
      cancel-in-progress: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x

      - name: Install Dependencies
        run: npm install --no-save --no-package-lock --no-audit cos-nodejs-sdk-v5 tsx

      - name: Run Image Link Check
        env:
          COS_SECRET_ID: ${{ secrets.COS_SECRET_ID }}
          COS_SECRET_KEY: ${{ secrets.COS_SECRET_KEY }}
          COS_BUCKET: ${{ secrets.COS_BUCKET }}
          COS_REGION: ${{ secrets.COS_REGION }}
          COS_CDN_URL: ${{ secrets.COS_CDN_URL }}
          COS_ALERT_WEBHOOK: ${{ secrets.COS_ALERT_WEBHOOK }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_RUN_NUMBER: ${{ github.run_number }}
        run: npx tsx scripts/check-image-links.ts

      - name: Upload Report Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: image-links-report-${{ github.run_number }}
          path: image-links-report.json
          retention-days: 7
          if-no-files-found: ignore
