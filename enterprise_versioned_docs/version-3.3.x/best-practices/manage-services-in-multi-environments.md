---
title: 使用网关组在多环境中管理服务
slug: /best-practices/manage-services-in-multi-environments
---

[网关组](../key-concepts/gateway-groups.md)是一个由一个或多个共享相同配置的网关实例组成的逻辑分组，这些网关实例在处理 API 请求时表现一致。用户可以为网关组命名，并为其添加标签，以此来区分和管理不同的环境和集群。

API7 企业版支持 `API 网关`和 `Ingress Controller` 两种类型的网关组管理，能帮助企业进行环境和集群的隔离，多区域多集群管理，以及根据业务线实现服务级别目标管理。

这篇指南将向你展示如何通过网关组实现在 `测试`、`UAT`、 `生产` 三个环境中的服务管理。

## 背景介绍

为确保服务稳定、合规及数据安全，服务的上线经历多个环境，包括测试环境、UAT 环境和生产环境。在没有多环境管理功能的情况下，研发人员需要部署 3 套独立的 API7 企业版，开发工程师、QA 工程师和运维工程师需要分别登录不同域名下的 API7 企业版控制台，对同一个 API 进行开发、测试和上线，在业务线非常多的情况下，会浪费大量机器和管理资源。

API7 企业版的网关组功能为研发人员提供了一个统一的入口，避免在多控制台中切换，可以实现简单便捷的发布操作，从而提高工作效率并减少操作错误。

![Multi-Environment Service Publishing](https://static.apiseven.com/uploads/2024/07/08/uxX5p7xl_multi-environment%20release.PNG)

## 前提条件

1. [安装 API7 企业版](../getting-started/install-api7-ee.md)。
2. 准备好服务在三个环境内的不同域名：`test.acme.com`、`uat.acme.com`、`prod.acme.com`。
3. 参考[新增网关组](../getting-started/add-gateway-group.md)，创建三个网关组：`测试`、`UAT` 和 `生产`，对应测试环境、UAT 环境和生产环境的使用。

## 在测试环境新增服务和路由

1. 从左侧菜单选择 `测试` 网关组下的**已发布服务**，然后点击**新增服务**。
2. 选择**手动新增**。
3. 在对话框中，执行以下操作：
   * **名称**填写 `httpbin`。
   * 点击 **+ 添加节点**。
   * 在对话框中，执行以下操作：
      * **主机**填写 `test.api7.ai`。
      * **端口**填写 `80`。
      * 点击**新增**。
4. 在**主机**字段中，点击 **+ 新增**。
   * 输入 `test.acme.com`。
5. 打开**添加第一条路由**按钮。
6. 在**第一个路由**对话框中，执行以下操作：
   * **名称**填写 `get-headers`。
   * **路径**填写 `headers`。
   * **HTTP 方法**选择 `GET`。
   * 点击**新增**。将创建一个处于“无版本”状态的新服务 `httpbin`。
7. 进入**上游**页面。
8. （可选）在**连接配置**模块中，点击**编辑**图标。
9. （可选）在**编辑连接配置**对话框中，执行以下操作：
   * **传递给上游的 Host 请求头**选择 `使用上游中指定的 Host`。
   * 点击**保存**。

> 注意：步骤 8 和 9 是可选的。必须将 **传递给上游的 Host 请求头* 参数更改为`使用上游中指定的 Host`，以确保与上游的握手成功。请根据你的用例进行相应的调整。

10. 模拟真实用户场景进行功能测试、性能测试和安全测试。

### 验证服务

测试后，发送请求以验证测试网关组中的 httpbin 服务：

```bash
curl "http://localhost:9080/headers" -v -H "Host: test.acme.com"
```

你应该能收到 `200 OK` 的响应。

## 将服务部署到 UAT 环境

1. 从左侧菜单选择 `测试` 网关组下的**已发布服务**。
2. 点击 `httpbin` 服务旁边的 **...**，然后点击**同步到其他网关组**。
3. 在**选择要同步到的网关组**字段中，选择 `UAT` 网关组，然后点击**下一步**。
4. 在对话框中，执行以下操作：
   * **版本**填写`1.0.0`。
   * **请求 URL** 填写`uat.acme.com`。
   * 在**上游配置**模块中，点击**编辑**。
   * 在对话框中，执行以下操作：
      * **主机**和**端口**填写入 `uat.api7.ai` 作为主机，`80` 作为端口。
      * **权重** 使用默认值 `100`。
      * 点击**保存**。
   * 确认服务信息，然后点击**同步**。`httpbin` 服务将同步到 `UAT` 网关组。
5. （可选）在**连接配置**模块中，点击**编辑**图标。
6. （可选）在**编辑连接配置**对话框中，执行以下操作：
   * **传递给上游的 Host 请求头**选择 `使用上游中指定的 Host`。
   * 点击**保存**。

> 注意：步骤 5 和 6 是可选的。必须将 **传递给上游的 Host 请求头* 参数更改为`使用上游中指定的 Host`，以确保与上游的握手成功。请根据你的用例进行相应的调整。

7. 在 `UAT` 网关组中，配置网关组的安全策略和合规性检查功能，例如进行[日志审计](../api-observability/logging.md)。

### 验证服务

测试后，发送请求以验证测试网关组中的 httpbin 服务：

```bash
curl "http://localhost:9080/headers" -v -H "Host: uat.acme.com"
```

你应该能收到 `200 OK` 的响应。

## 将服务部署到生产环境

1. 从左侧菜单选择 `UAT` 网关组下的**已发布服务**。
2. 点击 `httpbin` 服务旁边的 **...**，然后点击**同步到其他网关组**。
3. 在**选择要同步到的网关组**字段中，选择 `生产` 网关组，然后点击**下一步**。
4. 在对话框中，执行以下操作：
   * **请求 URL**填写 `production.acme.com`。
   * 在**上游配置**模块中，点击**编辑**。
   * 在**编辑节点**对话框中，执行以下操作：
      * **主机**和**端口**填写 `prod.api7.ai` 作为主机，`80` 作为端口。
      * **权重**使用默认值 `100`。
      * 点击**保存**。
   * 确认服务信息，然后点击**同步**。`httpbin` 服务将同步到 `生产` 网关组。
8. （可选）在**连接配置**模块中，点击**编辑**图标。
9. （可选）在**编辑连接配置**对话框中，执行以下操作：
   * **传递给上游的 Host 请求头**选择 `使用上游中指定的 Host`。
   * 点击**保存**。

> 注意：步骤 5 和 6 是可选的。必须将 **传递给上游的 Host 请求头* 参数更改为`使用上游中指定的 Host`，以确保与上游的握手成功。请根据你的用例进行相应的调整。

7. 定期审查和分析 `httpbin` 的日志，执行日志管理，并识别潜在的问题以进行改进。
8. 制定详细的回滚计划，包括回滚步骤、所需时间和责任人员，并在必要时[回滚已发布的服务](../getting-started/rollback-service.md)。

### 验证服务

测试后，发送请求以验证测试网关组中的 httpbin 服务：

```bash
curl "http://localhost:9080/headers" -v -H "Host: production.acme.com"
```

你应该能收到 `200 OK` 的响应。

## 总结

测试、UAT 和生产环境是软件开发生命周期的重要组成部分。通过利用 API7 企业版的网关组，你可以实现物理和逻辑隔离，从而增强安全性、可控性和效率。此外，灵活调整路由规则和管理服务版本的能力可确保应用程序的平滑和敏捷版本管理。