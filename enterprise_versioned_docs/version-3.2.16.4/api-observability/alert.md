---
title: 网关告警通知
slug: /api-observability/alert
---

异常流量模式或 API 网关使用错误可能表明存在问题或恶意攻击。通过为特定阈值和活动设置告警，你可以快速检测并深入了解可能的安全漏洞、滥用或异常使用。

本教程将指导你创建告警策略，以便在特定事件发生时接收邮件和 webhook 通知。

## 前提条件

1. [安装 API7 企业版](../getting-started/install-api7-ee.md)。
2. [在网关组上运行 API](../getting-started/launch-your-first-api.md)。
3. 获取通知系统的 webhook URL。

## 设置 SMTP 服务器

1. 从顶部导航栏中选择**组织**，然后选择**设置**。
2. 点击**SMTP 服务器**选项卡。
3. 点击**启用**。
4. 在对话框中，执行以下操作：
   * **SMTP 服务器地址**，输入你的 SMTP 服务器的地址。例如，`127.0.0.1`。
   * **用户名**和**密码**，输入连接到你的 SMTP 服务器的凭据。
   * **发件人姓名**，输入 `API7 企业版` 以在邮件中将此名称显示为发件人。
   * **发件人邮箱地址**，输入 `noreply@api7.ai`。这将用作实际的发件人地址。
   * 点击**启用**。

## 添加联系人

_联系人_ 定义了一组可由多个告警策略复用的邮件地址或 webhook URL。

### 添加邮件联系人

1. 从顶部导航栏中选择**组织**，然后选择**联系人**。
2. 点击**新增联系人**。
3. 在对话框中，执行以下操作：
   * **名称**，输入 `应急小组邮件列表`。
   * **类型**，选择 `邮件`。
   * **邮件地址**，输入 `emergencyteamlist@api7.ai`。
   * 点击**新增**。

### 添加 Webhook 联系人

使用 [Slack 接收 webhook](https://api.slack.com/messaging/webhooks) 将来自 API7 企业版的消息发布到 Slack。

1. 从顶部导航栏中选择**组织**，然后选择**联系人**。
2. 点击**新增联系人**。
3. 在对话框中，执行以下操作：
   * **名称**，输入 `Slack 通知`。
   * **类型**，选择 `Webhook`。
   * **URL**，输入 `https://hooks.slack.com/services/T00000000/B00000000/XXXXXXXXXXXXXXXXXXXXXXXX`。
   * 点击**新增**。

## 添加告警策略

有关更多告警邮件内容示例，请参阅[告警变量和模板](../reference/alert-template.md)。告警策略会在创建或更新后立即开始监控，首次检查会在指定的检查间隔后进行。

### 监控控制面证书到期事件

控制面证书在实例部署时激活，用于验证网关实例身份。这些证书的有效期为 13 个月。

要主动监控即将过期的控制面证书并发出告警，可以配置一个每日任务以检查证书到期日期。如果证书即将到期（30 天内），请向应急小组发送邮件告警，并在 Slack 上发布通知。

1. 从侧边栏选择**告警**，然后点击**策略**。
2. 点击**新增告警策略**。
3. 在对话框中，执行以下操作：
   * **名称**，输入 `控制面证书将过期`。
   * **告警等级**，选择 `高`。
   * **检查间隔**，输入 `1440` 分钟。
   * **触发条件**，执行以下操作：
      * **条件类型**，选择 `满足下列所有条件 (AND)`。
      * **事件**，选择 `控制面证书即将过期`。
      * **触发网关组**，选择 `全选`。
      * **规则**，填空 `控制面证书将在 30 天内过期`。
   * 点击**新增通知**。
   * 在对话框中，执行以下操作：
      * **类型**，选择 `邮件`。
      * **联系人**，选择 `应急小组邮件列表`。
      * **告警邮件主题**，输入 `[API7 告警] [{{.Severity}}] 控制面证书到期警告`。
      * **告警邮件内容**，输入 `告警时间：{{.AlertTime.Format "2024 Dec 31 17:00:00"}}，详情：{{.AlertDetail}}`。
      * 点击**新增**。
   * 点击**新增通知**。
   * 在对话框中，执行以下操作：
      * **类型**，选择 `Webhook`。
      * **联系人**，选择 `Slack 通知`。
      * **告警消息**，输入

      ```json
      "text": "{{{ .AlertDetail }}} 发生于 {{{ .AlertTime.Format "2024 Dec 31 17:00:00" }}}."
      ```

      * 点击**新增**。

5. 点击**新增**。

#### 验证

假设网关组 `生产网关组` 中的网关实例 `gateway 123` 的控制面证书将于 2024-12-31 过期，并且告警策略已于 2024-12-10 触发。

1. 从侧边栏选择**告警**，然后点击**历史记录**。
2. 你应该会根据案例看到一个告警记录。点击**详情**：
   * 告警策略：控制面证书过期
   * 告警等级：高
   * 告警时间：5 分钟前
   * 触发网关组：生产网关组
   * 告警详情：网关实例证书：gateway 123 将在 21 天内过期。

3. 发送的邮件将类似于：

```text
* 主题：[API7 告警][高] 控制面证书到期警告
* 告警时间：2024 DEC 31 17:00:00，详情：网关实例证书：gateway 123 将在 21 天内过期。
```

4. 你将在 Slack 中收到一条消息：

```text
网关实例证书：gateway 123 将在 2024 DEC 31 17:00:00 的 21 天内过期。
```

```markdown
### 监控控制面到数据面的 mTLS 证书到期

CA 证书支持控制面和数据面之间安全的 mTLS 通信，并在实例部署时激活。要主动监控即将过期的控制面 CA 证书并发出告警，请实施每日任务以检查 CA 证书到期日期。如果 CA 证书即将到期（30 天内），请向应急小组发送邮件告警，并在 Slack 上发布通知。

1. 从侧边栏选择**告警**，然后点击**策略**。
2. 点击**新增告警策略**。
3. 在对话框中，执行以下操作：
   * **名称**，输入 `控制面 CA 证书过期`。
   * **告警等级**，选择 `高`。
   * **检查间隔**，输入 `1440` 分钟。
   * **触发条件**，执行以下操作：
      * **运算符**，选择 `满足下列所有条件 (AND)`。
      * **事件**，选择 `控制面和数据面之间的 mTLS 证书即将过期`。
      * **触发网关组**，选择 `全选`。
      * **规则**，填空 `数据面和控制面之间的 mTLS 证书将在 30 天内过期`。

   * 点击**新增通知**。
   * 在对话框中，执行以下操作：
      * **类型**，选择 `邮件`。
      * **联系人**，选择 `应急小组邮件列表`。
      * **告警邮件主题**，输入 `[API7 告警] 控制面 CA 证书到期警告`。
      * **告警邮件内容**，输入 `告警时间：{{.AlertTime.Format "2024 Dec 31 17:00:00"}}，详情：{{.AlertDetail}}`。
      * 点击**新增**。

   * 点击**新增通知**。
   * 在对话框中，执行以下操作：
      * **类型**，选择 `Webhook`。
      * **联系人**，选择 `Slack 通知`。
      * **告警消息**，输入

      ```json
      "text": "{{{ .AlertDetail }}}发生于{{{ .AlertTime.Format "2024 Dec 31 17:00:00" }}}."
      ```

      * 点击**新增**。

5. 点击**新增**。

#### 验证

假设网关组 `生产网关组` 中的网关实例 `gateway 123` 的控制面 CA 证书已于 2024-12-31 过期，并且告警策略已于 2024-12-10 触发。

1. 从侧边栏选择**告警**，然后点击**历史记录**。
2. 你应该会根据案例看到一个告警记录。点击**详情**：
   * 告警策略：控制面 CA 证书过期
   * 告警等级：高
   * 告警时间：5 分钟前
   * 触发网关组：生产网关组
   * 告警详情：网关实例的 CA 证书：gateway 123 将在 21 天内过期。

3. 发送的邮件将类似于：

```text
* 主题：[API7 告警] 控制面 CA 证书到期警告
* 告警时间：2024 DEC 31 17:00:00，详情：网关实例的 CA 证书：gateway 123 将在 21 天内过期。
```

4. 你将在 Slack 中收到一条消息：

```text
网关实例的 CA 证书：gateway 123 将在 2024 DEC 31 17:00:00 的 21 天内过期。
```

### 检测网关实例离线

如果网关实例（数据面节点）超过 2 小时未向控制面报告心跳。如果此状态持续 7 天，则数据面节点将被自动删除，并标记为 `offline`。

实施每小时任务以检测并在出现问题时向应急小组发送邮件告警和 Slack 通知。然后，应该有人尝试恢复离线的网关实例。

1. 从侧边栏选择**告警**，然后点击**策略**。
2. 点击**新增告警策略**。
3. 在对话框中，执行以下操作：
   * **名称**，输入 `网关实例离线`。
   * **告警等级**，选择 `中`。
   * **检查间隔**，输入 `60` 分钟。
   * **触发条件**，执行以下操作：
      * **运算符**，选择 `满足下列所有条件 (AND)`。
      * **事件**，选择 `网关实例离线`。
      * **触发网关组**，选择 `全选`。
      * **规则**，填空 `网关组中的任何网关实例离线超过 1 小时`。

   * 点击**新增通知**。
   * 在对话框中，执行以下操作：
      * **类型**，选择 `邮件`。
      * **联系人**，选择 `应急小组邮件列表`。
      * **告警邮件主题**，输入 `[API7 告警] 网关实例离线警告`。
      * **告警邮件内容**，输入 `告警时间：{{.AlertTime.Format "2024 Dec 31 17:00:00"}}，详情：{{.AlertDetail}}`。
      * 点击**新增**。

   * 点击**新增通知**。
   * 在对话框中，执行以下操作：
      * **类型**，选择 `Webhook`。
      * **联系人**，选择 `Slack 通知`。
      * **告警消息**，输入

      ```json
      "text": "{{{ .AlertDetail }}}发生于{{{ .AlertTime.Format "2024 Dec 31 17:00:00" }}}."
      ```

      * 点击**新增**。

5. 点击**新增**。

#### 验证

假设网关组 `生产网关组` 中的网关实例 `gateway 123` 在 2024-12-31 14:00:00 离线，网关组 `test group` 中的网关实例 `gateway 456` 在 2024-12-31 13:00:00 离线。
告警策略在 2024-12-31 17:00:00 触发。

1. 从侧边栏选择**告警**，然后点击**历史记录**。
2. 你应该会根据案例看到一个告警记录。点击**详情**：
   * 告警策略：网关实例离线
   * 告警等级：高
   * 告警时间：5 分钟前
   * 触发网关组：生产网关组
   * 告警详情：网关实例：网关组 生产网关组 中的 gateway 123 已离线 3 小时。\ 网关实例：网关组 test group 中的 gateway 456 已离线 4 小时。

3. 发送的邮件将类似于：

```text
* 主题：[API7 告警] 网关实例离线警告
* 告警时间：2024 DEC 31 17:00:00，详情：网关实例：网关组 生产网关组 中的 gateway 123 已离线 3 小时。\ 网关实例：网关组 test group 中的 gateway 456 已离线 4 小时。
```

4. 你将在 Slack 中收到一条消息：

```text
网关实例：网关组 生产网关组 中的 gateway 123 已离线 3 小时。
网关实例：网关组 test group 中的 gateway 456 已离线 4 小时。
时间：2024 DEC 31 17:00:00。
```

```markdown
### 检测 CPU 核心数超出限制

如果所有网关组的 CPU 核心使用量连续七天超过许可的 CPU 核心数限制，则资源添加或修改将受到限制。但是，现有的服务和路由将继续运行。

实施每小时任务以检测生产环境的所有网关组，并在出现问题时向应急小组发送邮件告警和 Slack 通知。

1. 从侧边栏选择**告警**，然后点击**策略**。
2. 点击**新增告警策略**。
3. 在对话框中，执行以下操作：
   * **名称**，输入 `CPU 核心数超出限制`。
   * **告警等级**，选择 `高`。
   * **检查间隔**，输入 `60` 分钟。
   * **触发条件**，执行以下操作：
      * **运算符**，选择 `满足下列所有条件 (AND)`。
      * **事件**，选择 `允许的许可证 CPU 配额已超出`。
   * 点击**新增通知**。
   * 在对话框中，执行以下操作：
      * **类型**，选择 `邮件`。
      * **联系人**，选择 `应急小组邮件列表`。
      * **告警邮件主题**，输入 `[API7 告警] CPU 核心数超出限制`。
      * **告警邮件内容**，输入 `告警时间：{{.AlertTime.Format "2024 Dec 31 17:00:00"}}，详情：{{.AlertDetail}}`。
      * 点击**新增**。

   * 点击**新增通知**。
   * 在对话框中，执行以下操作：
      * **类型**，选择 `Webhook`。
      * **联系人**，选择 `Slack 通知`。
      * **告警消息**，输入

      ```json
      "text": "{{{ .AlertDetail }}}发生于{{{ .AlertTime.Format "2024 Dec 31 17:00:00" }}}."
      ```

      * 点击**新增**。

5. 点击**新增**。

#### 验证

假设你的 API7 企业版许可证限制为 100 个 CPU 核心，并且从 2024-12-1 开始已连续 21 天超出此限制。

1. 从侧边栏选择**告警**，然后点击**历史记录**。
2. 你应该会根据案例看到一个告警记录。点击**详情**：
   * 告警策略：CPU 核心数超出限制
   * 告警等级：中
   * 告警时间：5 分钟前
   * 触发网关组：生产网关组
   * 告警详情：所有网关组的 CPU 总使用量为 110c，超过了允许的许可证 CPU 配额 100c。

3. 发送的邮件将类似于：

```text
* 主题：[API7 告警] 网关实例离线警告
* 告警时间：2024 DEC 31 17:00:00，详情：所有网关组的 CPU 总使用量为 110c，超过了允许的许可证 CPU 配额 100c。
```

4. 你将在 Slack 中收到一条消息：

```text
所有网关组的 CPU 总使用量为 110c，在 2024 DEC 31 17:00:00 超过了允许的许可证 CPU 配额 100c。
```

### 计算网关组中的健康网关实例数

如果网关组中健康网关实例的数量低于临界阈值，则表明可能会出现服务中断并影响流量处理。
这种情况在 Kubernetes 部署中尤其重要，因为网关实例可能会遇到故障或意外缩减。

实施高频任务以检测并在出现问题时向应急小组发送邮件告警和 Slack 通知。

1. 从侧边栏选择**告警**，然后点击**策略**。
2. 点击**新增告警策略**。
3. 在对话框中，执行以下操作：
   * **名称**，输入 `生产组中没有足够的健康网关实例`。
   * **告警等级**，选择 `高`。
   * **检查间隔**，输入 `30` 分钟。
   * **触发网关组**，选择 `生产组`。
   * **触发条件**，执行以下操作：
      * **运算符**，选择 `满足下列所有条件 (AND)`。
      * **事件**，选择 `健康网关实例的数量`。
      * **规则**，填空 `网关组中的网关实例数少于 50`。
   * 点击**新增通知**。
   * 在对话框中，执行以下操作：
      * **类型**，选择 `邮件`。
      * **联系人**，选择 `应急小组邮件列表`。
      * **告警邮件主题**，输入 `[API7 告警] 生产组中没有足够的健康网关实例`。
      * **告警邮件内容**，输入 `告警时间：{{.AlertTime.Format "2024 Dec 31 17:00:00"}}，详情：{{.AlertDetail}}`。
      * 点击**新增**。

   * 点击**新增通知**。
   * 在对话框中，执行以下操作：
      * **类型**，选择 `Webhook`。
      * **联系人**，选择 `Slack 通知`。
      * **告警消息**，输入

      ```json
      "text": "{{{ .AlertDetail }}}发生于{{{ .AlertTime.Format "2024 Dec 31 17:00:00" }}}."
      ```

      * 点击**新增**。

5. 点击**新增**。

#### 验证

假设你的网关组 `生产组` 至少需要 50 个健康的网关实例。但是，截至 2024 年 12 月 31 日 17:00:00，只有 40 个实例正在运行。这种严重的不足可能会导致服务降级和潜在的停机。需要立即关注以解决此问题。

1. 从侧边栏选择**告警**，然后点击**历史记录**。
2. 你应该会根据案例看到一个告警记录。点击**详情**：
   * 告警策略：生产组中没有足够的健康网关实例
   * 告警等级：高
   * 告警时间：5 分钟前
   * 触发网关组：生产组
   * 告警详情：网关组：生产组 中的健康网关实例数为 40。

3. 发送的邮件将类似于：

```text
* 主题：[API7 告警] 生产组中没有足够的健康网关实例
* 告警时间：2024 DEC 31 17:00:00，详情：网关组：生产组 中的健康网关实例数为 40。
```

4. 你将在 Slack 中收到一条消息：

```text
网关组：生产组 中的健康网关实例数为 40。时间：2024 DEC 31 17:00:00。
```

```markdown
### 监控状态码

如果特定 API 响应状态码的数量超过阈值（例如，过多的 500 错误），则表明可能会出现服务中断并影响流量处理。

实施高频任务以检测并在出现问题时向应急小组发送邮件告警和 Slack 通知。

1. 从侧边栏选择**告警**，然后点击**策略**。
2. 点击**新增告警策略**。
3. 在对话框中，执行以下操作：
   * **名称**，输入 `生产网关组中的 500 状态码过多`。
   * **告警等级**，选择 `高`。
   * **检查间隔**，输入 `30` 分钟。
   * **触发网关组**，选择 `匹配标签`，然后输入键/值 `envType: production`。
   * **触发条件**，执行以下操作：
      * **运算符**，选择 `满足下列所有条件 (OR)`。
      * **事件**，选择 `状态码 500 的数量`。
      * **规则**，填空 `任何一个网关组的所有已发布服务收到的状态码为 500 的请求数量在过去 60 分钟内已达到或超过 100 次`。
   * 点击**新增条件**。
   * **触发条件**，执行以下操作：
      * **事件**，选择 `状态码 500 的比率`。
      * **规则**，填空 `任何一个网关组的所有已发布服务收到的状态码为 500 的请求比率在过去 60 分钟内已达到或超过 10%`。
   * 点击**新增通知**。
   * 在对话框中，执行以下操作：
      * **类型**，选择 `邮件`。
      * **联系人**，选择 `应急小组邮件列表`。
      * **告警邮件主题**，输入 `[API7 告警] {{{ .TriggerGatewayGroup }}} 中的 500 状态码过多`。
      * **告警邮件内容**，输入 `告警时间：{{.AlertTime.Format "2024 Dec 31 17:00:00"}}，详情：{{.AlertDetail}}`。
      * 点击**新增**。

   * 点击**新增通知**。
   * 在对话框中，执行以下操作：
      * **类型**，选择 `Webhook`。
      * **联系人**，选择 `Slack 通知`。
      * **告警消息**，输入

      ```json
      "text": "{{{ .AlertDetail }}}发生于{{{ .AlertTime.Format "2024 Dec 31 17:00:00" }}}."
      ```

      * 点击**新增**。

5. 点击**新增**。

#### 验证

假设你的网关组 `VIP 组` 具有标签 `envType:production`，在 2024 年 12 月 31 日 16:00 到 17:00 之间经历了 15% 的错误率。在 1000 个请求中，有 150 个导致 500 错误。并且网关组 `US 组` 具有标签 `envType:production`，在 2024 年 12 月 31 日 16:00 到 17:00 之间经历了 10% 的错误率。在 500 个请求中，有 50 个导致 500 错误。

1. 从侧边栏选择**告警**，然后点击**历史记录**。
2. 你应该会根据案例看到一个告警记录。点击**详情**：
   * 告警策略：生产网关组中的 500 状态码过多
   * 告警等级：高
   * 告警时间：5 分钟前
   * 触发网关组：VIP 组
   * 告警详情：网关组的所有已发布服务收到的状态码为 500 的请求数量：VIP 组在过去 60 分钟内为 150 次。\ 网关组的所有已发布服务收到的状态码为 500 的请求比率：VIP 组在过去 60 分钟内为 15%。\ 网关组的所有已发布服务收到的状态码为 500 的请求比率：US 组在过去 60 分钟内为 10%。

3. 发送的邮件将类似于：

```text
* 主题：[API7 告警] [API7 告警] VIP 组、US 组中的 500 状态码过多
* 告警时间：2024 DEC 31 17:00:00，详情：网关组的所有已发布服务收到的状态码为 500 的请求数量：VIP 组在过去 60 分钟内为 150 次。网关组的所有已发布服务收到的状态码为 500 的请求比率：VIP 组在过去 60 分钟内为 15%。网关组的所有已发布服务收到的状态码为 500 的请求比率：US 组在过去 60 分钟内为 10%。
```

4. 你将在 Slack 中收到一条消息：

```text
网关组的所有已发布服务收到的状态码为 500 的请求数量：VIP 组在过去 60 分钟内为 150 次。
网关组的所有已发布服务收到的状态码为 500 的请求比率：VIP 组在过去 60 分钟内为 15%。
网关组的所有已发布服务收到的状态码为 500 的请求比率：US 组在过去 60 分钟内为 10%。
时间：2024 DEC 31 17:00:00。
```


