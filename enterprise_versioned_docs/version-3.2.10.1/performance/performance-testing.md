---
title: 性能测试报告
slug: /performance/performance-testing
---

## 测试方法

- **环境**：AWS 基础设施上的 Kubernetes 环境。
- **测试用例**：
  1. 未开启任何插件的请求；
  2. 开启 key-auth 身份认证插件的请求；
  3. 开启 limit-count 插件的请求；
  4. 开启 key-auth 和 limit-count 插件的请求；
- **路由和消费者**：
  1. 单条路由和单个消费者；
  2. 100 条路由和 100 个消费者；
- **样本大小**：每个测试用例运行 5 次，每次持续 2 分钟。统计的结果为 5 次测试结果的平均值。


## 性能基准测试结果

|                                   | **API7 Gateway（1 CPU）**    |  | **API7 Gateway（16 CPU）** |  |
| --------------------------------- | -------------------------------- | ----------------------------- |----------------------------- |----------------------------- |
|                                   | **QPS**    | **Latency（毫秒）** | **QPS** | **Latency（毫秒）** |
| 单路由无插件                        | 24129.22                         | 85159.03                      | todo                      |todo                      |
| 100 条路由无插件                        | 24129.22                         | 85159.03                      | todo                      |todo                      |
| 单路由开启 limit-count            | 19874.72                         | 70294.34                      | todo                      |todo                      |
| 100 条路由开启 limit-count            | 19874.72                         | 70294.34                      | todo                      |todo                      |
| 单路由开启 key-auth               | 20055.76                         | 71063.02                      | todo                      |todo                      |
| 100 条路由开启 key-auth               | 20055.76                         | 71063.02                      | todo                      |todo                      |
| 单路由开启 key-auth + limit count | 18279.8                          | 65100.51                      | todo                      |todo                      |
| 100 条路由开启 key-auth + limit count | 18279.8                          | 65100.51                      | todo                      |todo                      |

## 测试环境

| 对象         | 详细信息                  |
| ------------ | ------------------------- |
| Node 配置    | Amazon Linux2(AL2_x86_64) |
| Kubernetes   | 1.29                      |
| API7 Gateway | 3.2.8.1                   |
| 上游服务     | nginx/1.25.4              |
| 压测工具     | wrk2                      |

| 服务            | 规格                             | 外网 IP | 内网 IP | 端口 |
| --------------- | -------------------------------- | ------- | ------- | ---- |
| API7 Gateway    | c5.2xlarge (8 vcpu，16 GiB 内存) |         |         | 9080 |
| API7 Dashboard  |                                  |         |         | 7080 |
| API7 DP Manager |                                  |         |         | 7900 |
| upstream        | c5.2xlarge (8 vcpu，16 GiB 内存) |         |         | 1980 |
| wrk2            | c5.2xlarge (8 vcpu，16 GiB 内存) |         |         |      |

## 测试配置

对于这些测试，我们更改了工作进程的数量，以匹配运行 API7 Gateway 的节点的可用核心数量（1、4、16 个 vCPU）。除此更改外，没有进行其他调整。

## 部署拓扑

![deploy](static/deploy.png)

## 各案例数据参考

### wrk2 参数

```bash
# 不过 gateway 直接压上游
wrk -c100 -t4 -d120 -R50000 -U http://172.31.6.98:1980/hello

# 1 work_process
wrk -c100 -t4 -d120 -R50000 -U http://_172.31.10.203_:9080/hello
wrk -c100 -t4 -d120 -R50000 -U http://_172.31.10.203_:9080/hello -H 'apikey: jack-key'

# 4 work_process
wrk -c200 -t4 -d120 -R200000 -U http://172.31.6.58:9080/hello
wrk -c200 -t4 -d120 -R200000 -U http://172.31.6.58:9080/hello -H 'apikey: jack-key'
```

### 单路由无插件

|                                         | QPS      | 延迟                                                                                                                                            |
| --------------------------------------- | -------- | ----------------------------------------------------------------------------------------------------------------------------------------------- |
| 不经过网关直连访问上游                  | 49876.39 | 50.000%  379.00us 75.000%  463.00us 90.000%  574.00us 99.000%  784.00us 99.900%    0.97ms 99.990%    1.22ms 99.999%    1.90ms100.000%    2.61ms |
| API7 Gateway 代理（1 worker_processes） | 24129.22 | 50.000%    4.09ms 75.000%    4.23ms 90.000%    4.42ms 99.000%    5.03ms 99.900%    6.14ms 99.990%    7.43ms 99.999%   12.07ms100.000%   15.96ms |
| API7 Gateway 代理（4 worker_processes） | 85159.03 | 50.000%    1.32ms 75.000%    3.05ms 90.000%    6.91ms 99.000%    8.48ms 99.900%    9.79ms 99.990%   11.91ms 99.999%   17.30ms100.000%   25.04ms |

### 单路由开启 limit-count

|                                         | QPS      | 延迟                                                                                                                                            |
| --------------------------------------- | -------- | ----------------------------------------------------------------------------------------------------------------------------------------------- |
| API7 Gateway 代理（1 worker_processes） | 19874.72 | 50.000%    4.90ms 75.000%    5.07ms 90.000%    5.65ms 99.000%    6.64ms 99.900%    8.82ms 99.990%    9.96ms 99.999%   14.40ms100.000%   18.24ms |
| API7 Gateway 代理（4 worker_processes） | 70294.34 | 50.000%    2.66ms 75.000%    3.26ms 90.000%    3.83ms 99.000%    5.62ms 99.900%    6.52ms 99.990%   19.49ms 99.999%   20.14ms100.000%   20.53ms |

### 单路由同时开启 key-auth 和 limit-count

|                                         | QPS      | 延迟                                                                                                                                            |
| --------------------------------------- | -------- | ----------------------------------------------------------------------------------------------------------------------------------------------- |
| API7 Gateway 代理（1 worker_processes） | 18279.80 | 50.000%    5.34ms 75.000%    5.49ms 90.000%    6.21ms 99.000%    7.27ms 99.900%    8.86ms 99.990%   10.68ms 99.999%   14.34ms100.000%   25.98ms |
| API7 Gateway 代理（4 worker_processes） | 65100.51 | 50.000%    2.71ms 75.000%    3.59ms 90.000%    4.51ms 99.000%    6.71ms 99.900%    7.88ms 99.990%   20.35ms 99.999%   22.19ms100.000%   24.08ms |

### 单路由开启 key-auth

|                                         | QPS      | 延迟                                                                                                                                            |
| --------------------------------------- | -------- | ----------------------------------------------------------------------------------------------------------------------------------------------- |
| API7 Gateway 代理（1 worker_processes） | 20055.76 | 50.000%    4.91ms 75.000%    5.07ms 90.000%    5.36ms 99.000%    6.21ms 99.900%    7.47ms 99.990%    9.64ms 99.999%   14.26ms100.000%   18.61ms |
| API7 Gateway 代理（4 worker_processes） | 71063.02 | 50.000%    2.74ms 75.000%    2.99ms 90.000%    3.36ms 99.000%    4.15ms 99.900%    5.17ms 99.990%   17.22ms 99.999%   20.14ms100.000%   20.30ms |

## 测试步骤

详细的测试步骤以及安装指南参考 [API7 EE v3 性能测试步骤](https://apiseven.feishu.cn/docx/UG7rdKgpHolRFrxmhwtcHhpQnId)
